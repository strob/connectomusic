<html>
  <head>
    <title>instrument</title>
    <script src="jquery.js"></script>
    <style>
body {
  background-color: black;
  margin: 0;
  padding: 0;
}
.node {
  position: absolute;
  z-index: 10;
  width: 10;
  height: 10;
  cursor: pointer;
}
.node:hover,.node.playing {
  background-color: yellow;
}
    </style>
  </head>
  <body>
    <script>
var GRAPH = function(spec) {
    var that = this;

    this.edges = spec.edges;
    this.nodes = spec.nodes;

    this.W = 1200;
    this.H = 1240;

    this.$el = $("<div>");

    this.$canvas = $("<canvas>")
        .attr({width: this.W,
              height:this.H})
        .appendTo(this.$el);
    this.draw_base();

    this.nodes.forEach(function(node) {
        var $node = $("<div>")
            .addClass('node')
            .offset({left: node.pt[0]-5,
                     top: node.pt[1]-5})
            .click(function() {

                var a = that.get_sound(node.nedges);
                $node.addClass('playing');
                a.ontimeupdate = function() {
                    var percent = a.currentTime / a.duration;
                    $node
                        .css({width: 10*(1-percent),
                              height:10*(1-percent)})
                        .offset({left: node.pt[0]-5*(1-percent),
                                 top: node.pt[1]-5*(1-percent)});
                };
                a.onended = function() {    // XXX: 'bind'/'unbind'?
                    console.log("spawn!");
                    $node.removeClass('playing')
                        .css({width: 10,
                              height:10})
                        .offset({left: node.pt[0]-5,
                                 top: node.pt[1]-5});
                };
                a.play();

            })
            .appendTo(that.$el);
    });
};
GRAPH.prototype.draw_base = function() {
    var that = this;
    var ctx = this.$canvas[0].getContext('2d');
    ctx.strokeStyle = "#ccc";
    ctx.beginPath();
    this.edges.forEach(function(edge) {
        var a = that.nodes[edge.a];
        var b = that.nodes[edge.b];
        ctx.moveTo(a.pt[0], a.pt[1]);
        ctx.lineTo(b.pt[0], b.pt[1]);
    });
    ctx.stroke();
};
GRAPH.prototype.set_sounds = function(snds) {
    this.sounds = {};
    for (var key in snds) {
        this.sounds[key] = snds[key].map(function(x) {
            var a = new Audio(x + '.ogg'); // XXX: or mp3!
            a.load();
            return a;
        });
    }
};
GRAPH.prototype.get_sound = function(n) {
    if(!n in this.sounds) {
        console.log('no sound for n', n);
        n = 19;
    }
    var out = this.sounds[n][0];
    this.sounds[n] = this.sounds[n].slice(1).concat([out]);
    return out;
};

var g;
$.getJSON('graph.json', {}, function(res) {
    $.getJSON('s2.json', {}, function(snd) {
        g = new GRAPH(res);
        g.set_sounds(snd);
        $("body").append(g.$el);
    });
});
    </script>
  </body>
</html>
